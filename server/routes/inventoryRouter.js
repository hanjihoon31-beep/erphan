// server/routes/inventoryRouter.js import express from "express"; import { verifyToken, verifyAdmin } from "../middleware/authMiddleware.js"; import Store from "../models/Store.js"; import Warehouse from "../models/Warehouse.js"; import Product from "../models/Product.js"; import Inventory from "../models/Inventory.js"; import MinimumStock from "../models/MinimumStock.js"; import StockTransfer from "../models/StockTransfer.js"; const router = express.Router(); // ==================== ë§¤ìž¥ ê´€ë¦?==================== // ?„ì²´ ë§¤ìž¥ ëª©ë¡ ì¡°íšŒ router.get("/stores", verifyToken, async (req, res) => { try { const stores = await Store.find().populate("manager", "name email").sort({ storeNumber: 1 }); res.json(stores); } catch (error) { console.error("ë§¤ìž¥ ëª©ë¡ ì¡°íšŒ ?¤ë¥˜:", error); res.status(500).json({ message: "ë§¤ìž¥ ëª©ë¡ ì¡°íšŒ ?¤íŒ¨" }); } }); // ë§¤ìž¥ ?ì„± (ê´€ë¦¬ìž ?„ìš©) router.post("/stores", verifyToken, verifyAdmin, async (req, res) => { try { const { storeNumber, storeName, location, manager, phone } = req.body; const existingStore = await Store.findOne({ storeNumber }); if (existingStore) { return res.status(400).json({ message: "?´ë? ì¡´ìž¬?˜ëŠ” ë§¤ìž¥ ë²ˆí˜¸?…ë‹ˆ??" }); } const newStore = await Store.create({ storeNumber, storeName, location, manager, phone, }); res.status(201).json({ success: true, store: newStore }); } catch (error) { console.error("ë§¤ìž¥ ?ì„± ?¤ë¥˜:", error); res.status(500).json({ message: "ë§¤ìž¥ ?ì„± ?¤íŒ¨" }); } }); // ë§¤ìž¥ ?˜ì • router.put("/stores/:id", verifyToken, verifyAdmin, async (req, res) => { try { const { storeName, location, manager, phone, isActive } = req.body; const updatedStore = await Store.findByIdAndUpdate( req.params.id, { storeName, location, manager, phone, isActive }, { new: true } ); if (!updatedStore) { return res.status(404).json({ message: "ë§¤ìž¥??ì°¾ì„ ???†ìŠµ?ˆë‹¤." }); } res.json({ success: true, store: updatedStore }); } catch (error) { console.error("ë§¤ìž¥ ?˜ì • ?¤ë¥˜:", error); res.status(500).json({ message: "ë§¤ìž¥ ?˜ì • ?¤íŒ¨" }); } }); // ë§¤ìž¥ ?? œ router.delete("/stores/:id", verifyToken, verifyAdmin, async (req, res) => { try { const storeId = req.params.id; const relatedInventory = await Inventory.countDocuments({ store: storeId }); if (relatedInventory > 0) { return res.status(400).json({ message: `??ë§¤ìž¥?ëŠ” ${relatedInventory}ê°œì˜ ?¬ê³  ?°ì´?°ê? ?ˆìŠµ?ˆë‹¤. ë¨¼ì? ?¬ê³ ë¥?ì²˜ë¦¬?´ì£¼?¸ìš”.` }); } const deletedStore = await Store.findByIdAndDelete(storeId); if (!deletedStore) { return res.status(404).json({ message: "ë§¤ìž¥??ì°¾ì„ ???†ìŠµ?ˆë‹¤." }); } res.json({ success: true, message: "ë§¤ìž¥???? œ?˜ì—ˆ?µë‹ˆ??" }); } catch (error) { console.error("ë§¤ìž¥ ?? œ ?¤ë¥˜:", error); res.status(500).json({ message: "ë§¤ìž¥ ?? œ ?¤íŒ¨" }); } }); // ==================== ì°½ê³  ê´€ë¦?==================== router.get("/warehouses", verifyToken, async (req, res) => { try { const warehouses = await Warehouse.find().sort({ warehouseName: 1 }); res.json(warehouses); } catch (error) { console.error("ì°½ê³  ëª©ë¡ ì¡°íšŒ ?¤ë¥˜:", error); res.status(500).json({ message: "ì°½ê³  ëª©ë¡ ì¡°íšŒ ?¤íŒ¨" }); } }); router.post("/warehouses", verifyToken, verifyAdmin, async (req, res) => { try { const { warehouseName, warehouseType, location, capacity } = req.body; const existingWarehouse = await Warehouse.findOne({ warehouseName }); if (existingWarehouse) { return res.status(400).json({ message: "?´ë? ì¡´ìž¬?˜ëŠ” ì°½ê³ ?…ë‹ˆ??" }); } const newWarehouse = await Warehouse.create({ warehouseName, warehouseType, location, capacity, }); res.status(201).json({ success: true, warehouse: newWarehouse }); } catch (error) { console.error("ì°½ê³  ?ì„± ?¤ë¥˜:", error); res.status(500).json({ message: "ì°½ê³  ?ì„± ?¤íŒ¨" }); } }); // ==================== ?œí’ˆ ê´€ë¦?==================== router.get("/products", verifyToken, async (req, res) => { try { const { search, category, storageType } = req.query; let query = { isActive: true }; if (search) { query.productName = { $regex: search, $options: "i" }; } if (category) query.category = category; if (storageType) query.storageType = storageType; const products = await Product.find(query).sort({ productName: 1 }); res.json(products); } catch (error) { console.error("?œí’ˆ ëª©ë¡ ì¡°íšŒ ?¤ë¥˜:", error); res.status(500).json({ message: "?œí’ˆ ëª©ë¡ ì¡°íšŒ ?¤íŒ¨" }); } }); // ==================== ?¬ê³  ==================== router.get("/stock", verifyToken, async (req, res) => { try { const { productId, lowStock } = req.query; let query = {}; if (productId) query.product = productId; const inventory = await Inventory.find(query) .populate("product", "productName category unit storageType") .populate("warehouse", "warehouseName warehouseType") .populate("store", "storeNumber storeName") .populate("lastUpdatedBy", "name email") .sort({ lastUpdatedAt: -1 }); let result = inventory; if (lowStock === "true") { result = inventory.filter(item => item.quantity <= item.minimumStock); } res.json(result); } catch (error) { console.error("?¬ê³  ì¡°íšŒ ?¤ë¥˜:", error); res.status(500).json({ message: "?¬ê³  ì¡°íšŒ ?¤íŒ¨" }); } }); // ==================== ?¬ê³  ?´ë™ ==================== router.post("/transfer", verifyToken, async (req, res) => { try { const { productId, fromWarehouseId, fromStoreId, toWarehouseId, toStoreId, quantity, reason } = req.body; if (!productId || !quantity || quantity <= 0) { return res.status(400).json({ message: "?œí’ˆê³??˜ëŸ‰???•ì¸?´ì£¼?¸ìš”." }); } const fromQuery = {}; if (fromWarehouseId) fromQuery.warehouse = fromWarehouseId; if (fromStoreId) fromQuery.store = fromStoreId; fromQuery.product = productId; const fromInventory = await Inventory.findOne(fromQuery); if (!fromInventory || fromInventory.quantity < quantity) { return res.status(400).json({ message: "ì¶œë°œì§€???¬ê³ ê°€ ë¶€ì¡±í•©?ˆë‹¤." }); } const isAdmin = req.user.role === "admin" || req.user.role === "superadmin"; const transfer = await StockTransfer.create({ product: productId, fromWarehouse: fromWarehouseId, fromStore: fromStoreId, toWarehouse: toWarehouseId, toStore: toStoreId, quantity, reason, requestedBy: req.user._id, status: isAdmin ? "?¹ì¸" : "?€ê¸?, approvedBy: isAdmin ? req.user._id : null, approvedAt: isAdmin ? new Date() : null }); if (isAdmin) { await processStockTransfer(transfer); } res.status(201).json({ success: true, message: "?¬ê³  ?´ë™???±ë¡?˜ì—ˆ?µë‹ˆ??" }); } catch (error) { console.error("?¬ê³  ?´ë™ ?”ì²­ ?¤ë¥˜:", error); res.status(500).json({ message: "?¬ê³  ?´ë™ ?”ì²­ ?¤íŒ¨" }); } }); async function processStockTransfer(transfer) { const { product, fromWarehouse, fromStore, toWarehouse, toStore, quantity } = transfer; const fromQuery = { product }; if (fromWarehouse) fromQuery.warehouse = fromWarehouse; if (fromStore) fromQuery.store = fromStore; const fromInventory = await Inventory.findOne(fromQuery); if (!fromInventory || fromInventory.quantity < quantity) { throw new Error("ì¶œë°œì§€ ?¬ê³ ê°€ ë¶€ì¡±í•©?ˆë‹¤."); } fromInventory.quantity -= quantity; fromInventory.lastUpdatedAt = new Date(); await fromInventory.save(); const toQuery = { product }; if (toWarehouse) toQuery.warehouse = toWarehouse; if (toStore) toQuery.store = toStore; let toInventory = await Inventory.findOne(toQuery); if (toInventory) { toInventory.quantity += quantity; toInventory.lastUpdatedAt = new Date(); await toInventory.save(); } else { await Inventory.create({ product, warehouse: toWarehouse, store: toStore, quantity, lastUpdatedAt: new Date() }); } transfer.status = "?„ë£Œ"; transfer.completedAt = new Date(); await transfer.save(); } export default router; 
