// server/routes/adminRouter.js import express from "express"; import User from "../models/User.js"; import { verifyToken, verifyAdmin, verifySuperAdmin } from "../middleware/authMiddleware.js"; const router = express.Router(); // ???¹ì¸ ?€ê¸°ì¤‘ ? ì? ëª©ë¡ ì¡°íšŒ router.get("/pending", async (req, res) => { try { const pendingUsers = await User.find({ status: "pending" }).select( "name email role status createdAt" ); res.json(pendingUsers); } catch (error) { console.error(error); res.status(500).json({ message: "?¹ì¸ ëª©ë¡ ë¶ˆëŸ¬?¤ê¸° ?¤ë¥˜" }); } }); // ??ê³„ì • ?¹ì¸ router.put("/approve/:id", async (req, res) => { try { const updated = await User.findByIdAndUpdate( req.params.id, { status: "active" }, { new: true } ); res.json(updated); } catch (error) { console.error(error); res.status(500).json({ message: "?¹ì¸ ì²˜ë¦¬ ?¤ë¥˜" }); } }); // ??ê³„ì • ê±°ì ˆ router.put("/reject/:id", async (req, res) => { try { const updated = await User.findByIdAndUpdate( req.params.id, { status: "rejected" }, { new: true } ); res.json(updated); } catch (error) { console.error(error); res.status(500).json({ message: "ê±°ì ˆ ì²˜ë¦¬ ?¤ë¥˜" }); } }); // ??ê¶Œí•œ ë³€ê²?router.put("/update-role/:id", async (req, res) => { try { const { role } = req.body; const updatedUser = await User.findByIdAndUpdate( req.params.id, { role }, { new: true } ); res.json({ success: true, updatedUser }); } catch (err) { res.status(500).json({ success: false, message: "ê¶Œí•œ ë³€ê²?ì¤??¤ë¥˜ ë°œìƒ" }); } }); // ???„ì²´ ?¬ìš©??ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ì?? router.get("/users", verifyToken, verifyAdmin, async (req, res) => { try { const users = await User.find().select("-password").sort({ createdAt: -1 }); res.json(users); } catch (error) { console.error(error); res.status(500).json({ message: "?¬ìš©??ëª©ë¡ ì¡°íšŒ ?¤ë¥˜" }); } }); // ???´ì‚¬ ì²˜ë¦¬ (ê³„ì • ë¹„í™œ?±í™”) router.put("/deactivate/:id", verifyToken, verifyAdmin, async (req, res) => { try { const { reason } = req.body; const targetUserId = req.params.id; if (targetUserId === req.user._id.toString()) { return res.status(400).json({ message: "?ê¸° ?ì‹ ??ë¹„í™œ?±í™”?????†ìŠµ?ˆë‹¤." }); } const targetUser = await User.findById(targetUserId); if (!targetUser) { return res.status(404).json({ message: "?¬ìš©?ë? ì°¾ì„ ???†ìŠµ?ˆë‹¤." }); } if (targetUser.status === "inactive") { return res.status(400).json({ message: "?´ë? ë¹„í™œ?±í™”??ê³„ì •?…ë‹ˆ??" }); } const updatedUser = await User.findByIdAndUpdate( targetUserId, { status: "inactive", inactivatedAt: new Date(), inactivatedBy: req.user._id, inactivationReason: reason || "?´ì‚¬" }, { new: true } ).select("-password"); res.json({ success: true, message: "ê³„ì •??ë¹„í™œ?±í™”?˜ì—ˆ?µë‹ˆ??", user: updatedUser }); } catch (error) { console.error("?´ì‚¬ ì²˜ë¦¬ ?¤ë¥˜:", error); res.status(500).json({ message: "?´ì‚¬ ì²˜ë¦¬ ì¤??¤ë¥˜ ë°œìƒ" }); } }); // ??ê³„ì • ?¬í™œ?±í™” router.put("/reactivate/:id", verifyToken, verifyAdmin, async (req, res) => { try { const targetUserId = req.params.id; const targetUser = await User.findById(targetUserId); if (!targetUser) { return res.status(404).json({ message: "?¬ìš©?ë? ì°¾ì„ ???†ìŠµ?ˆë‹¤." }); } if (targetUser.status !== "inactive") { return res.status(400).json({ message: "ë¹„í™œ?±í™”??ê³„ì •???„ë‹™?ˆë‹¤." }); } const updatedUser = await User.findByIdAndUpdate( targetUserId, { status: "active", $unset: { inactivatedAt: ", inactivatedBy: ", inactivationReason: " } }, { new: true } ).select("-password"); res.json({ success: true, message: "ê³„ì •???¬í™œ?±í™”?˜ì—ˆ?µë‹ˆ??", user: updatedUser }); } catch (error) { console.error("?¬í™œ?±í™” ?¤ë¥˜:", error); res.status(500).json({ message: "?¬í™œ?±í™” ì¤??¤ë¥˜ ë°œìƒ" }); } }); export default router; 
