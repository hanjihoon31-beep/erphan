// server/routes/authRouter.js import express from 'express'; import bcrypt from 'bcrypt'; import jwt from 'jsonwebtoken'; import User from '../models/User.js'; const router = express.Router(); // ???Œì›ê°€??(?¹ì¸ ?€ê¸? router.post("/register", async (req, res) => { try { const { employeeId, name, email, password, role } = req.body; // ì¤‘ë³µ ì²´í¬ const existingUserByEmail = await User.findOne({ email }); if (existingUserByEmail) { return res.status(400).json({ success: false, message: "?´ë? ?±ë¡???´ë©”?¼ì…?ˆë‹¤." }); } const existingUserById = await User.findOne({ employeeId }); if (existingUserById) { return res.status(400).json({ success: false, message: "?´ë? ?±ë¡???¬ë²ˆ?…ë‹ˆ??" }); } const hashedPassword = await bcrypt.hash(password, 10); await User.create({ employeeId, name, email, password: hashedPassword, role: role || "employee", isApproved: false, // ?¹ì¸ ?€ê¸?isActive: true }); res.status(201).json({ success: true, message: "ê´€ë¦¬ì ?¹ì¸ ?€ê¸?ì¤‘ì…?ˆë‹¤." }); } catch (error) { console.error("?Œì›ê°€???¤ë¥˜:", error); res.status(500).json({ success: false, message: "?œë²„ ?¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤." }); } }); // ??ë¡œê·¸??(?¬ë²ˆ?¼ë¡œ ë¡œê·¸?? ?¹ì¸??ê³„ì •ë§? router.post("/login", async (req, res) => { try { const { employeeId, password } = req.body; const user = await User.findOne({ employeeId }); if (!user) { return res.status(400).json({ success: false, message: "ì¡´ì¬?˜ì? ?ŠëŠ” ?¬ë²ˆ?…ë‹ˆ??" }); } // ?¹ì¸ ?•ì¸ if (!user.isApproved) { return res.status(403).json({ success: false, message: "ê´€ë¦¬ì ?¹ì¸ ?€ê¸?ì¤‘ì…?ˆë‹¤." }); } // ê³„ì • ?œì„±???•ì¸ if (!user.isActive) { return res.status(403).json({ success: false, message: "ë¹„í™œ?±í™”??ê³„ì •?…ë‹ˆ?? ê´€ë¦¬ì?ê²Œ ë¬¸ì˜?˜ì„¸??" }); } // ë¹„ë?ë²ˆí˜¸ ?•ì¸ const isMatch = await bcrypt.compare(password, user.password); if (!isMatch) { return res.status(400).json({ success: false, message: "ë¹„ë?ë²ˆí˜¸ê°€ ?¼ì¹˜?˜ì? ?ŠìŠµ?ˆë‹¤." }); } // JWT ? í° ?ì„± const token = jwt.sign( { userId: user._id, employeeId: user.employeeId, role: user.role }, process.env.JWT_SECRET, { expiresIn: "24h" } ); res.json({ success: true, token, role: user.role, name: user.name, employeeId: user.employeeId }); } catch (error) { console.error("ë¡œê·¸???¤ë¥˜:", error); res.status(500).json({ success: false, message: "ë¡œê·¸??ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤." }); } }); export default router; 
