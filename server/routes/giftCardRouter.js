// server/routes/giftCardRouter.js import express from 'express'; import { verifyToken, verifyAdmin } from "../middleware/authMiddleware.js"; import GiftCardType from "../models/GiftCardType.js"; const router = express.Router(); // ==================== ?í’ˆê¶?ì¢…ë¥˜ ê´€ë¦?==================== // ëª¨ë“  ?í’ˆê¶?ì¢…ë¥˜ ì¡°íšŒ (?œì„±?”ëœ ê²ƒë§Œ) router.get("/", verifyToken, async (req, res) => { try { const { includeInactive } = req.query; let query = {}; if (!includeInactive) { query.isActive = true; } const giftCards = await GiftCardType.find(query) .populate("createdBy", "name email") .populate("deactivatedBy", "name email") .sort({ createdAt: -1 }); res.json(giftCards); } catch (error) { console.error("?í’ˆê¶?ì¢…ë¥˜ ì¡°íšŒ ?¤ë¥˜:", error); res.status(500).json({ message: "?í’ˆê¶?ì¢…ë¥˜ ì¡°íšŒ ?¤íŒ¨" }); } }); // ?í’ˆê¶?ì¢…ë¥˜ ?±ë¡ (ê´€ë¦¬ì) router.post("/", verifyToken, verifyAdmin, async (req, res) => { try { const { name } = req.body; if (!name || !name.trim()) { return res.status(400).json({ message: "?í’ˆê¶??´ë¦„???…ë ¥?´ì£¼?¸ìš”." }); } // ì¤‘ë³µ ?•ì¸ const existing = await GiftCardType.findOne({ name: name.trim() }); if (existing) { return res.status(400).json({ message: "?´ë? ?±ë¡???í’ˆê¶Œì…?ˆë‹¤." }); } const giftCard = await GiftCardType.create({ name: name.trim(), createdBy: req.user._id }); res.status(201).json({ success: true, giftCard }); } catch (error) { console.error("?í’ˆê¶?ì¢…ë¥˜ ?±ë¡ ?¤ë¥˜:", error); res.status(500).json({ message: "?í’ˆê¶?ì¢…ë¥˜ ?±ë¡ ?¤íŒ¨" }); } }); // ?í’ˆê¶?ì¢…ë¥˜ ?˜ì • (ê´€ë¦¬ì) router.put("/:id", verifyToken, verifyAdmin, async (req, res) => { try { const { name } = req.body; if (!name || !name.trim()) { return res.status(400).json({ message: "?í’ˆê¶??´ë¦„???…ë ¥?´ì£¼?¸ìš”." }); } const giftCard = await GiftCardType.findById(req.params.id); if (!giftCard) { return res.status(404).json({ message: "?í’ˆê¶Œì„ ì°¾ì„ ???†ìŠµ?ˆë‹¤." }); } // ì¤‘ë³µ ?•ì¸ (?ê¸° ?ì‹  ?œì™¸) const existing = await GiftCardType.findOne({ name: name.trim(), _id: { $ne: req.params.id } }); if (existing) { return res.status(400).json({ message: "?´ë? ?±ë¡???í’ˆê¶??´ë¦„?…ë‹ˆ??" }); } giftCard.name = name.trim(); await giftCard.save(); res.json({ success: true, giftCard }); } catch (error) { console.error("?í’ˆê¶?ì¢…ë¥˜ ?˜ì • ?¤ë¥˜:", error); res.status(500).json({ message: "?í’ˆê¶?ì¢…ë¥˜ ?˜ì • ?¤íŒ¨" }); } }); // ?í’ˆê¶?ì¢…ë¥˜ ë¹„í™œ?±í™” (ê´€ë¦¬ì) router.delete("/:id", verifyToken, verifyAdmin, async (req, res) => { try { const giftCard = await GiftCardType.findById(req.params.id); if (!giftCard) { return res.status(404).json({ message: "?í’ˆê¶Œì„ ì°¾ì„ ???†ìŠµ?ˆë‹¤." }); } giftCard.isActive = false; giftCard.deactivatedBy = req.user._id; giftCard.deactivatedAt = new Date(); await giftCard.save(); res.json({ success: true, message: "?í’ˆê¶Œì´ ë¹„í™œ?±í™”?˜ì—ˆ?µë‹ˆ??" }); } catch (error) { console.error("?í’ˆê¶?ì¢…ë¥˜ ë¹„í™œ?±í™” ?¤ë¥˜:", error); res.status(500).json({ message: "?í’ˆê¶?ì¢…ë¥˜ ë¹„í™œ?±í™” ?¤íŒ¨" }); } }); // ?í’ˆê¶?ì¢…ë¥˜ ?¬í™œ?±í™” (ê´€ë¦¬ì) router.patch("/:id/reactivate", verifyToken, verifyAdmin, async (req, res) => { try { const giftCard = await GiftCardType.findById(req.params.id); if (!giftCard) { return res.status(404).json({ message: "?í’ˆê¶Œì„ ì°¾ì„ ???†ìŠµ?ˆë‹¤." }); } giftCard.isActive = true; giftCard.deactivatedBy = null; giftCard.deactivatedAt = null; await giftCard.save(); res.json({ success: true, message: "?í’ˆê¶Œì´ ?¬í™œ?±í™”?˜ì—ˆ?µë‹ˆ??" }); } catch (error) { console.error("?í’ˆê¶?ì¢…ë¥˜ ?¬í™œ?±í™” ?¤ë¥˜:", error); res.status(500).json({ message: "?í’ˆê¶?ì¢…ë¥˜ ?¬í™œ?±í™” ?¤íŒ¨" }); } }); export default router; 
